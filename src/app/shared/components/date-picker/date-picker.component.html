<div class="relative">
  @if (label()) {
    <label class="block text-sm font-medium text-gray-700 mb-1">
      {{ label() }}
    </label>
  }

  <button
    type="button"
    class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-left focus:outline-none focus:ring-2 td-ring-primary disabled:bg-gray-100 disabled:cursor-not-allowed flex items-center justify-between gap-2"
    [disabled]="isDisabled()"
    (click)="toggle()"
    aria-haspopup="dialog"
    [attr.aria-expanded]="isOpen()">
    <span class="block truncate text-gray-900">
      @if (displayValue()) {
        {{ displayValue() }}
      } @else {
        <span class="text-gray-400">Seleccionar fecha</span>
      }
    </span>
    <svg
      class="w-5 h-5 text-gray-900 shrink-0"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
  </button>

  @if (isOpen()) {
    <div
      class="absolute z-30 mt-2 w-full max-w-sm bg-white rounded-2xl shadow-lg p-6 min-h-[24rem]"
      role="dialog"
      aria-label="Selector de fecha">
      <div class="flex items-center justify-between mb-4">
        <button type="button" class="td-text-primary hover:opacity-80" (click)="prev()" aria-label="Anterior">
          ‹
        </button>
        <div class="flex items-center gap-6">
          <button
            type="button"
            class="td-text-primary font-medium capitalize px-2 py-1 rounded-md border border-transparent hover:bg-gray-100 hover:border-gray-200"
            (click)="openMonthSelector()"
            aria-label="Seleccionar mes">
            {{ monthLabel() }}
          </button>
          <button
            type="button"
            class="td-text-primary font-medium px-2 py-1 rounded-md border border-transparent hover:bg-gray-100 hover:border-gray-200"
            (click)="openYearSelector()"
            aria-label="Seleccionar año">
            {{ yearLabel() }}
          </button>
        </div>
        <button type="button" class="td-text-primary hover:opacity-80" (click)="next()" aria-label="Siguiente">
          ›
        </button>
      </div>

      @if (viewMode() === 'day') {
        <div class="grid grid-cols-7 gap-3 mb-2 text-sm text-slate-500">
          <div class="text-center">Sun</div>
          <div class="text-center">Mon</div>
          <div class="text-center">Tue</div>
          <div class="text-center">Wed</div>
          <div class="text-center">Thu</div>
          <div class="text-center">Fri</div>
          <div class="text-center">Sat</div>
        </div>

        <div class="grid grid-cols-7 gap-3">
          @for (cell of dayCells(); track trackKey(cell.date)) {
            <div class="flex items-center justify-center">
              @if (cell.inCurrentMonth) {
                @if (isSelected(cell)) {
                  <div class="rounded-lg p-[2px] ring-2 td-ring-primary">
                    <button
                      type="button"
                      class="w-10 h-10 rounded-lg border-2 td-border-primary bg-white td-text-primary font-semibold flex items-center justify-center"
                      (click)="select(cell)">
                      {{ cell.date.getDate() }}
                    </button>
                  </div>
                } @else {
                  <button
                    type="button"
                    class="w-10 h-10 rounded-lg flex items-center justify-center text-slate-900 hover:bg-gray-100"
                    [class.bg-gray-100]="isWeekend(cell)"
                    [class.hover:bg-gray-200]="isWeekend(cell)"
                    [class.text-slate-500]="isWeekend(cell) && !isToday(cell)"
                    [class.td-text-primary]="isToday(cell)"
                    [class.font-medium]="isToday(cell)"
                    (click)="select(cell)">
                    {{ cell.date.getDate() }}
                  </button>
                }
              } @else {
                <div
                  class="w-10 h-10 rounded-lg flex items-center justify-center text-slate-300"
                  [class.bg-gray-100]="isWeekend(cell)">
                  {{ cell.date.getDate() }}
                </div>
              }
            </div>
          }
        </div>
      } @else if (viewMode() === 'month') {
        <div class="grid grid-cols-3 gap-3 max-h-72 overflow-auto pr-1">
          @for (m of months(); track m.index) {
            <button
              type="button"
              class="w-full h-10 rounded-lg flex items-center justify-center capitalize text-slate-900 bg-white border border-transparent hover:bg-gray-100 hover:border-gray-200"
              [class.font-semibold]="m.index === viewMonth()"
              [class.td-text-primary]="m.index === viewMonth()"
              [class.ring-2]="m.index === viewMonth()"
              [class.td-ring-primary]="m.index === viewMonth()"
              [class.border-2]="m.index === viewMonth()"
              [class.td-border-primary]="m.index === viewMonth()"
              (click)="selectMonth(m.index)">
              {{ m.label }}
            </button>
          }
        </div>
      } @else {
        <div class="grid grid-cols-4 gap-3 max-h-72 overflow-auto pr-1">
          @for (y of years(); track y) {
            <button
              type="button"
              class="w-full h-10 rounded-lg flex items-center justify-center text-slate-900 bg-white border border-transparent hover:bg-gray-100 hover:border-gray-200"
              [class.font-semibold]="y === viewYear()"
              [class.td-text-primary]="y === viewYear()"
              [class.ring-2]="y === viewYear()"
              [class.td-ring-primary]="y === viewYear()"
              [class.border-2]="y === viewYear()"
              [class.td-border-primary]="y === viewYear()"
              (click)="selectYear(y)">
              {{ y }}
            </button>
          }
        </div>
      }
    </div>
  }
</div>

