<div class="relative w-full">
  <div class="relative">
    <input
      #inputEl
      [id]="inputId()"
      type="text"
      role="combobox"
      [attr.aria-label]="ariaLabel() ?? null"
      [attr.aria-controls]="listboxId()"
      [attr.aria-expanded]="isOpen()"
      [attr.aria-autocomplete]="'list'"
      [attr.aria-required]="ariaRequired() ? 'true' : null"
      [attr.aria-activedescendant]="activeDescendantId()"
      [disabled]="isDisabled()"
      [value]="displayValue()"
      [placeholder]="placeholder()"
      autocomplete="off"
      (click)="toggle()"
      (input)="onInput($event)"
      (blur)="onBlur()"
      (keydown)="onKeydown($event)"
      class="td-combobox-input w-full bg-white border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm leading-5 text-gray-900 placeholder:italic placeholder:text-gray-500 focus:outline-none focus:ring-1 td-ring-primary disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed" />

    <button
      type="button"
      class="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8 flex items-center justify-center rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-1 td-ring-primary"
      [disabled]="isDisabled()"
      aria-label="Abrir opciones"
      (click)="$event.preventDefault(); focusInput(); toggle()">
      <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
        <path
          fill-rule="evenodd"
          d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z"
          clip-rule="evenodd" />
      </svg>
    </button>
  </div>

  @if (isOpen()) {
    <div
      class="absolute z-50 mt-1 w-full rounded-md border border-gray-300 bg-white shadow-sm overflow-hidden"
      role="listbox"
      [id]="listboxId()">
      @if (filteredOptions().length === 0) {
        <div class="px-4 py-3 text-sm text-gray-500">Sin resultados</div>
      } @else {
        @for (opt of filteredOptions(); track opt.value; let i = $index) {
          <div
            role="option"
            [id]="inputId() + '-opt-' + opt.value"
            [attr.aria-selected]="value() === opt.value"
            (pointerenter)="onOptionPointerEnter(i)"
            (pointerdown)="$event.preventDefault(); select(opt)"
            class="td-combobox-option cursor-pointer px-4 py-3 text-sm text-left"
            [class.bg-gray-100]="i === activeIndex()"
            [class.td-text-primary]="value() === opt.value"
            [class.text-gray-900]="value() !== opt.value">
            {{ opt.label }}
          </div>
        }
      }
    </div>
  }
</div>
