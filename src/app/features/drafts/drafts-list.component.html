<app-wizard-layout
  [currentStep]="1"
  [totalSteps]="1"
  [showStepper]="false"
  [showBack]="false"
  [showNext]="false">
  <div class="max-w-3xl mx-auto">
    <app-content-card title="Listado de Test Drives">
      <button
        cardActions
        type="button"
        class="td-btn td-btn--emphasized inline-flex items-center gap-2 whitespace-nowrap text-xs h-9 px-3"
        (click)="createNew()"
        [disabled]="isCreating()"
        [attr.aria-busy]="isCreating()">
        <svg viewBox="0 0 20 20" class="w-4 h-4" aria-hidden="true">
          <path
            d="M10 4v12M4 10h12"
            fill="none"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round" />
        </svg>
        @if (isCreating()) { Creando... } @else { Nuevo test-drive }
      </button>
      <p class="text-sm text-gray-600 mb-4">
        Selecciona un formulario para continuar o revisar el detalle.
      </p>

      <div class="flex flex-wrap gap-2 mb-4">
        <button
          type="button"
          class="px-3 py-1.5 text-sm rounded-full border transition-colors"
          [class.td-bg-primary]="selectedStatus() === 'all'"
          [class.text-white]="selectedStatus() === 'all'"
          [class.border-transparent]="selectedStatus() === 'all'"
          [class.bg-white]="selectedStatus() !== 'all'"
          [class.text-gray-700]="selectedStatus() !== 'all'"
          [class.border-gray-200]="selectedStatus() !== 'all'"
          (click)="setStatusFilter('all')">
          Todos
        </button>
        <button
          type="button"
          class="px-3 py-1.5 text-sm rounded-full border transition-colors"
          [class.td-bg-primary]="selectedStatus() === 'draft'"
          [class.text-white]="selectedStatus() === 'draft'"
          [class.border-transparent]="selectedStatus() === 'draft'"
          [class.bg-white]="selectedStatus() !== 'draft'"
          [class.text-gray-700]="selectedStatus() !== 'draft'"
          [class.border-gray-200]="selectedStatus() !== 'draft'"
          (click)="setStatusFilter('draft')">
          En Progreso
        </button>
        <button
          type="button"
          class="px-3 py-1.5 text-sm rounded-full border transition-colors"
          [class.td-bg-primary]="selectedStatus() === 'submitted'"
          [class.text-white]="selectedStatus() === 'submitted'"
          [class.border-transparent]="selectedStatus() === 'submitted'"
          [class.bg-white]="selectedStatus() !== 'submitted'"
          [class.text-gray-700]="selectedStatus() !== 'submitted'"
          [class.border-gray-200]="selectedStatus() !== 'submitted'"
          (click)="setStatusFilter('submitted')">
          Finalizados
        </button>
      </div>

      @if (isLoading()) {
        <div class="space-y-3">
          <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
          <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
          <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
        </div>
      } @else {
        @if (filteredForms().length === 0) {
          <div class="rounded-lg border border-gray-200 bg-white p-4 text-gray-700">
            No hay formularios disponibles para este filtro.
          </div>
        } @else {
          <div class="space-y-3">
            @for (form of filteredForms(); track form.id) {
              <div
                role="button"
                tabindex="0"
                class="w-full text-left rounded-lg border border-gray-200 bg-white p-4 shadow-sm hover:bg-gray-50 focus:outline-none focus-visible:td-ring-primary transition cursor-pointer"
                [class.opacity-70]="openingId() === form.id"
                [class.pointer-events-none]="openingId() === form.id"
                (click)="openDraft(form)"
                (keydown)="onCardKeydown($event, form)">
                <div class="flex flex-col gap-2">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="text-sm font-semibold text-gray-900 truncate">
                        {{ form.customer?.firstName || '—' }} {{ form.customer?.lastName || '' }}
                      </div>
                    </div>
                    <div class="shrink-0 flex items-center gap-2">
                      <span
                        class="inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-semibold"
                        [class.bg-amber-100]="form.status === 'draft'"
                        [class.text-amber-900]="form.status === 'draft'"
                        [class.bg-emerald-100]="form.status === 'submitted'"
                        [class.text-emerald-800]="form.status === 'submitted'">
                        {{ form.status === 'draft' ? 'En Progreso' : 'Finalizado' }}
                      </span>
                    </div>
                  </div>

                  <div class="flex flex-wrap items-center justify-between gap-2">
                    @if (form.status === 'submitted') {
                      @let prob = form.purchaseProbability;
                      @let time = form.estimatedPurchaseDate;
                      <div class="inline-flex items-center gap-2 text-xs text-gray-600">
                        <span class="text-gray-500">Intención de compra:</span>
                        <span class="text-gray-900 font-semibold">
                          @if (prob === null || prob === undefined) { — } @else { {{ prob }}% }
                        </span>
                        <span class="text-gray-400">·</span>
                        <span class="text-gray-800 truncate">{{ (time ?? '').trim().length ? time : '—' }}</span>
                      </div>
                    } @else {
                      @let current = progressIndex(form);
                      <div class="w-full sm:w-auto">
                        <div class="flex items-center justify-start sm:justify-center gap-1.5 overflow-x-auto">
                          <div class="flex items-center min-w-max">
                            @for (step of [1, 2, 3, 4, 5, 6]; track step) {
                              <div class="flex items-center">
                                <button
                                  type="button"
                                  class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-semibold shrink-0 focus:outline-none focus-visible:td-ring-primary disabled:opacity-60 disabled:cursor-default"
                                  [disabled]="step > current"
                                  [style.background-color]="step < current ? 'var(--td-step-done-fill)' : step === current ? 'var(--td-step-fill)' : 'var(--td-step-todo-bg)'"
                                  [style.color]="'#ffffff'"
                                  (click)="toggleProgressTooltip($event, form, step)"
                                  [attr.aria-current]="step === current ? 'step' : null"
                                  [attr.aria-label]="'Paso ' + step">
                                  {{ step }}
                                </button>
                                @if (step < 6) {
                                  <div
                                    class="relative w-3 sm:w-5 h-1 mx-1 shrink-0 rounded-full overflow-hidden"
                                    [style.background-color]="step < current ? 'var(--td-step-done-fill)' : 'var(--td-step-todo-bg)'">
                                    <div class="h-full origin-left" [style.backgroundColor]="'var(--td-step-done-fill)'" [style.transform]="step < current ? 'scaleX(1)' : 'scaleX(0)'" style="transition: transform 220ms cubic-bezier(0.2,0,0,1)"></div>
                                  </div>
                                }
                              </div>
                            }
                          </div>
                        </div>
                        @if (openProgressTooltip()?.formId === form.id) {
                          <div class="mt-2 rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs text-gray-700 shadow-sm">
                            {{ tooltipText(form, openProgressTooltip()!.step) }}
                          </div>
                        }
                      </div>
                    }

                    <span class="text-sm text-gray-700">
                      <span class="text-gray-500">Asesor:</span>
                      <span class="text-gray-900 font-medium">{{ form.salesExpert || '—' }}</span>
                    </span>
                  </div>

                  <div class="text-sm text-gray-700 flex flex-wrap gap-x-3 gap-y-1">
                    <span class="text-gray-500">
                      Teléfono:
                      <span class="text-gray-800">{{ form.customer?.phoneNumber || '—' }}</span>
                    </span>
                    <span class="text-gray-500">Ubicación: <span class="text-gray-800">{{ form.location?.locationName || '—' }}</span></span>
                  </div>

                  <div class="pt-2 mt-1 border-t border-gray-200 text-xs text-gray-500 w-full">
                    Fecha: {{ formatDate(form.createdAt) }}
                  </div>
                </div>
              </div>
            }
          </div>
        }
      }
    </app-content-card>
  </div>
</app-wizard-layout>
