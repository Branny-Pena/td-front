<app-wizard-layout
  [currentStep]="1"
  [totalSteps]="1"
  [showStepper]="false"
  [showBottomNav]="false">
  <div class="max-w-3xl mx-auto">
    <app-content-card title="Encuestas">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <p class="text-sm text-gray-600">
          Crea encuestas, administra versiones y revisa respuestas (modo desarrollo).
        </p>

        <div class="flex items-center gap-2">
          <button type="button" class="td-btn td-btn--emphasized" (click)="openCreate()">
            Crear encuesta
          </button>
        </div>
      </div>

      @if (isLoading()) {
        <div class="space-y-3">
          <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
          <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
        </div>
      } @else {
        @if (surveys().length === 0) {
          <div class="rounded-lg border border-gray-200 bg-white p-4 text-gray-700">
            Aún no hay encuestas creadas.
          </div>
        } @else {
          <div class="space-y-3">
            @for (survey of surveys(); track survey.id) {
              <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-sm font-semibold text-gray-900 truncate">
                      {{ survey.name }}
                    </div>
                    <div class="mt-1 text-sm text-gray-700 flex flex-wrap gap-x-3 gap-y-1">
                      <span class="text-gray-500">Marca: <span class="text-gray-800">{{ formatBrand(survey.brand) }}</span></span>
                      <span class="text-gray-500">
                        Versión actual:
                        <span class="text-gray-800">
                          @if (currentVersionBySurveyId()[survey.id] === null) {
                            (sin versión)
                          } @else {
                            {{ currentVersionBySurveyId()[survey.id] }}
                          }
                        </span>
                      </span>
                    </div>
                  </div>

                  <div class="shrink-0 flex flex-col items-end gap-2">
                    <span
                      class="inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-semibold"
                      [class.bg-emerald-100]="survey.isActive"
                      [class.text-emerald-800]="survey.isActive"
                      [class.bg-gray-200]="!survey.isActive"
                      [class.text-gray-800]="!survey.isActive">
                      {{ survey.isActive ? 'Activa' : 'Inactiva' }}
                    </span>
                    <a [routerLink]="['/encuestas', survey.id]" class="td-text-primary text-sm font-medium">
                      Administrar
                    </a>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      }
    </app-content-card>
  </div>

  <app-modal-dialog
    [isOpen]="isCreateOpen()"
    title="Crear encuesta"
    rejectText="Cancelar"
    acceptText="Crear"
    [acceptDisabled]="!canCreate()"
    (closed)="closeCreate()"
    (reject)="closeCreate()"
    (accept)="createSurvey()">
    <form [formGroup]="createForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-800 mb-1" for="surveyName">Nombre</label>
        <input
          id="surveyName"
          type="text"
          formControlName="name"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary"
          placeholder="Encuesta de satisfacción" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-800 mb-1" for="surveyBrand">Marca</label>
        <div class="relative w-full group">
          <select
            id="surveyBrand"
            formControlName="brand"
            class="w-full appearance-none bg-white border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm leading-5 text-gray-900 focus:outline-none focus:ring-1 td-ring-primary disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed">
            @for (opt of brandOptions; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
          <div class="pointer-events-none absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8 flex items-center justify-center rounded-md text-gray-700 group-hover:bg-gray-100">
            <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
              <path
                fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z"
                clip-rule="evenodd" />
            </svg>
          </div>
        </div>
      </div>
    </form>
  </app-modal-dialog>
</app-wizard-layout>
