<app-wizard-layout
  [currentStep]="1"
  [totalSteps]="1"
  [showStepper]="false"
  [showBottomNav]="false">
  <div class="max-w-4xl mx-auto">
    @if (version(); as v) {
      <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
        <a [routerLink]="['/encuestas', v.survey?.id]" class="td-btn td-btn--standard">Volver</a>
        <div class="text-sm text-gray-600">
          <span class="font-semibold text-gray-900">{{ v.survey?.name }}</span>
          <span class="text-gray-500"> · </span>
          Versión {{ v.version }}
        </div>
      </div>
    } @else {
      <div class="mb-4">
        <a routerLink="/encuestas" class="td-btn td-btn--standard">Volver</a>
      </div>
    }

    <div class="mb-4 flex items-center justify-between gap-3">
      <div
        role="tablist"
        aria-label="Pestañas de la versión"
        class="inline-flex rounded-[10px] border border-gray-200 bg-white p-1 shadow-sm">
        <button
          type="button"
          role="tab"
          class="px-4 py-2 text-sm font-medium rounded-[8px] transition-colors"
          [attr.aria-selected]="activeTab() === 'answers'"
          [class.td-bg-primary]="activeTab() === 'answers'"
          [class.text-white]="activeTab() === 'answers'"
          [class.text-gray-700]="activeTab() !== 'answers'"
          (click)="setTab('answers')">
          Respuestas
        </button>
        <button
          type="button"
          role="tab"
          class="px-4 py-2 text-sm font-medium rounded-[8px] transition-colors"
          [attr.aria-selected]="activeTab() === 'content'"
          [class.td-bg-primary]="activeTab() === 'content'"
          [class.text-white]="activeTab() === 'content'"
          [class.text-gray-700]="activeTab() !== 'content'"
          (click)="setTab('content')">
          Contenido
        </button>
      </div>

      @if (activeTab() === 'answers') {
        <button
          type="button"
          class="td-btn td-btn--standard"
          (click)="loadResponses()"
          [disabled]="isResponsesLoading()">
          Actualizar
        </button>
      }
    </div>

    @if (activeTab() === 'answers') {
      <app-content-card title="Respuestas">
        <div class="flex flex-wrap gap-2 mb-4">
          <button
            type="button"
            class="px-3 py-1.5 text-sm rounded-full border transition-colors"
            [class.td-bg-primary]="selectedResponseFilter() === 'all'"
            [class.text-white]="selectedResponseFilter() === 'all'"
            [class.border-transparent]="selectedResponseFilter() === 'all'"
            [class.bg-white]="selectedResponseFilter() !== 'all'"
            [class.text-gray-700]="selectedResponseFilter() !== 'all'"
            [class.border-gray-200]="selectedResponseFilter() !== 'all'"
            (click)="setResponseFilter('all')">
            Todas
          </button>
          <button
            type="button"
            class="px-3 py-1.5 text-sm rounded-full border transition-colors"
            [class.td-bg-primary]="selectedResponseFilter() === 'started'"
            [class.text-white]="selectedResponseFilter() === 'started'"
            [class.border-transparent]="selectedResponseFilter() === 'started'"
            [class.bg-white]="selectedResponseFilter() !== 'started'"
            [class.text-gray-700]="selectedResponseFilter() !== 'started'"
            [class.border-gray-200]="selectedResponseFilter() !== 'started'"
            (click)="setResponseFilter('started')">
            Iniciadas
          </button>
          <button
            type="button"
            class="px-3 py-1.5 text-sm rounded-full border transition-colors"
            [class.td-bg-primary]="selectedResponseFilter() === 'submitted'"
            [class.text-white]="selectedResponseFilter() === 'submitted'"
            [class.border-transparent]="selectedResponseFilter() === 'submitted'"
            [class.bg-white]="selectedResponseFilter() !== 'submitted'"
            [class.text-gray-700]="selectedResponseFilter() !== 'submitted'"
            [class.border-gray-200]="selectedResponseFilter() !== 'submitted'"
            (click)="setResponseFilter('submitted')">
            Enviadas
          </button>
        </div>

        @if (isResponsesLoading()) {
          <div class="space-y-3">
            <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
            <div class="h-20 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
          </div>
        } @else {
          @if (filteredResponses().length === 0) {
            <div class="rounded-lg border border-gray-200 bg-white p-4 text-gray-700">
              No hay respuestas para este filtro.
            </div>
          } @else {
            <div class="space-y-3">
              @for (r of filteredResponses(); track r.id) {
                <a
                  class="block rounded-lg border border-gray-200 bg-white p-4 shadow-sm hover:bg-gray-50 focus:outline-none focus-visible:td-ring-primary transition"
                  [routerLink]="['/encuestas/respuestas', r.id]"
                  [queryParams]="{ fromVersionId: versionIdForLinks() }">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="text-sm font-semibold text-gray-900 truncate">
                        {{ r.testDriveForm.customer.firstName }} {{ r.testDriveForm.customer.lastName }}
                      </div>
                      <div class="mt-1 text-sm text-gray-700 flex flex-wrap gap-x-3 gap-y-1">
                        @if (r.testDriveForm.customer.email) {
                          <span class="text-gray-500">
                            Email: <span class="text-gray-800">{{ r.testDriveForm.customer.email }}</span>
                          </span>
                        }
                        @if (r.testDriveForm.customer.phoneNumber) {
                          <span class="text-gray-500">
                            Teléfono: <span class="text-gray-800">{{ r.testDriveForm.customer.phoneNumber }}</span>
                          </span>
                        }
                      </div>
                      <div class="mt-2 text-xs text-gray-500">
                        Fecha: {{ formatDate(r.submittedAt ?? r.createdAt) }}
                      </div>
                    </div>

                    <div class="shrink-0 flex flex-col items-end gap-2">
                      <span
                        class="inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-semibold"
                        [class.bg-gray-200]="r.status === 'started'"
                        [class.text-gray-900]="r.status === 'started'"
                        [class.bg-emerald-100]="r.status === 'submitted'"
                        [class.text-emerald-800]="r.status === 'submitted'">
                        {{ r.status === 'submitted' ? 'Enviada' : 'Iniciada' }}
                      </span>
                      <span class="td-text-primary text-sm font-medium">Ver</span>
                    </div>
                  </div>
                </a>
              }
            </div>
          }
        }
      </app-content-card>
    } @else {
      <app-content-card title="Preguntas">
        @if (isLoading()) {
          <div class="space-y-3">
            <div class="h-16 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
            <div class="h-16 rounded-lg border border-gray-200 bg-gray-50 animate-pulse"></div>
          </div>
        } @else {
          @if (version()?.questions?.length === 0) {
            <div class="rounded-lg border border-gray-200 bg-white p-4 text-gray-700">
              Aún no hay preguntas en esta versión.
            </div>
          } @else {
            <div class="space-y-3">
              @for (q of (version()?.questions ?? []); track q.id) {
                <div class="rounded-lg border border-gray-200 bg-white p-4">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="text-sm font-semibold text-gray-900">
                        {{ q.orderIndex }}. {{ q.label }}
                        @if (q.isRequired) {
                          <span class="ml-2 text-xs font-semibold text-amber-700 bg-amber-100 rounded-full px-2 py-0.5">
                            Requerida
                          </span>
                        }
                      </div>
                      <div class="mt-1 text-sm text-gray-600">
                        Tipo: {{ q.type }}
                        @if (q.type === 'number') {
                          <span class="text-gray-500"> · </span>
                          Escala {{ q.minValue }} - {{ q.maxValue }}
                        }
                      </div>
                      @if (q.options?.length) {
                        <div class="mt-2 flex flex-wrap gap-2">
                          @for (opt of q.options; track opt.id) {
                            <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-800 px-2 py-1 text-xs">
                              {{ opt.label }}
                            </span>
                          }
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        }
      </app-content-card>

      @if (isReadOnly()) {
        <div class="mt-4 rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-700">
          Esta encuesta está en estado <span class="font-semibold">Lista</span> y es de solo lectura.
        </div>
      }

      <div class="mt-4">
        @if (!isReadOnly()) {
          <app-content-card title="Agregar pregunta">
            <form [formGroup]="questionForm" class="space-y-4" (ngSubmit)="addQuestion()">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-800 mb-1" for="qType">Tipo</label>
                  <div class="relative w-full" id="td-question-type-dropdown">
                    <button
                      type="button"
                      id="qType"
                      class="w-full text-left bg-white border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm leading-5 text-gray-900 focus:outline-none focus:ring-1 td-ring-primary"
                      aria-haspopup="listbox"
                      [attr.aria-expanded]="isTypeMenuOpen()"
                      (click)="toggleTypeMenu()"
                      (keydown)="onTypeButtonKeydown($event)">
                      {{ selectedTypeLabel() }}
                    </button>

                    <button
                      type="button"
                      class="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8 flex items-center justify-center rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-1 td-ring-primary"
                      aria-label="Abrir opciones"
                      (click)="$event.preventDefault(); toggleTypeMenu()">
                      <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                        <path
                          fill-rule="evenodd"
                          d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z"
                          clip-rule="evenodd" />
                      </svg>
                    </button>

                    @if (isTypeMenuOpen()) {
                      <div
                        class="absolute z-50 mt-1 w-full rounded-md border border-gray-300 bg-white shadow-sm overflow-hidden"
                        role="listbox"
                        aria-label="Tipo de pregunta">
                        @for (opt of typeOptions; track opt.value; let i = $index) {
                          <button
                            type="button"
                            role="option"
                            class="td-combobox-option w-full text-left cursor-pointer px-4 py-3 text-sm"
                            [attr.aria-selected]="questionForm.controls.type.value === opt.value"
                            [class.bg-gray-100]="i === typeActiveIndex()"
                            [class.td-text-primary]="questionForm.controls.type.value === opt.value"
                            [class.text-gray-900]="questionForm.controls.type.value !== opt.value"
                            (pointerenter)="onTypeOptionPointerEnter(i)"
                            (pointerdown)="$event.preventDefault(); selectType(opt.value)">
                            {{ opt.label }}
                          </button>
                        }
                      </div>
                    }
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-800 mb-1" for="qOrder">Orden</label>
                  <input
                    id="qOrder"
                    type="number"
                    min="1"
                    formControlName="orderIndex"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary" />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-800 mb-1" for="qLabel">Pregunta</label>
                <input
                  id="qLabel"
                  type="text"
                  formControlName="label"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary"
                  placeholder="Ej: ¿Cómo calificaría su experiencia?" />
              </div>

              <label class="inline-flex items-center gap-2 text-sm text-gray-800">
                <input type="checkbox" formControlName="isRequired" class="h-4 w-4" />
                Requerida
              </label>

              @if (isNumberType()) {
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-800 mb-1" for="qMin">Mínimo</label>
                    <input
                      id="qMin"
                      type="number"
                      formControlName="minValue"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary" />
                    @if (questionForm.controls.minValue.touched && questionForm.controls.minValue.invalid) {
                      <div class="mt-1 text-sm text-red-600">Requerido</div>
                    }
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-800 mb-1" for="qMax">Máximo</label>
                    <input
                      id="qMax"
                      type="number"
                      formControlName="maxValue"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary" />
                    @if (questionForm.controls.maxValue.touched && questionForm.controls.maxValue.invalid) {
                      <div class="mt-1 text-sm text-red-600">Requerido</div>
                    }
                  </div>
                </div>
                @if (questionForm.touched && questionForm.errors?.['minGreaterThanMax']) {
                  <div class="mt-2 text-sm text-red-600">El mínimo no puede ser mayor que el máximo.</div>
                }
              }

              @if (isOptionType()) {
                <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-3">
                  <div class="flex items-center justify-between gap-2">
                    <div class="text-sm font-semibold text-gray-900">Opciones</div>
                    <button type="button" class="td-btn td-btn--standard h-8 px-3" (click)="addOption()">
                      Agregar opción
                    </button>
                  </div>

                  <div class="space-y-3">
                    @for (optCtrl of options().controls; track $index; let i = $index) {
                      <div class="grid grid-cols-1 sm:grid-cols-[1fr,1fr,auto] gap-3 items-end">
                        <div [formGroup]="optCtrl">
                          <label class="block text-xs font-medium text-gray-700 mb-1">Etiqueta</label>
                          <input
                            type="text"
                            formControlName="label"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary"
                            placeholder="Ej: Sí" />
                        </div>
                        <div [formGroup]="optCtrl">
                          <label class="block text-xs font-medium text-gray-700 mb-1">Valor</label>
                          <input
                            type="text"
                            formControlName="value"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 td-ring-primary"
                            placeholder="Ej: YES" />
                        </div>
                        <button
                          type="button"
                          class="td-btn td-btn--standard h-9 px-3"
                          (click)="removeOption(i)"
                          [disabled]="options().length <= 1">
                          Quitar
                        </button>
                      </div>
                    }
                  </div>
                  @if (questionForm.controls.options.touched && questionForm.controls.options.errors?.['required']) {
                    <div class="text-sm text-red-600">Agrega al menos una opción.</div>
                  }
                </div>
              }

              <div class="flex justify-end">
                <button type="submit" class="td-btn td-btn--emphasized" [disabled]="!canAddQuestion()">
                  Agregar
                </button>
              </div>
            </form>
          </app-content-card>
        }
      </div>

      @if (!isReadOnly() && (version()?.questions?.length ?? 0) > 0) {
        <div class="mt-4 flex justify-end">
          <a class="td-btn td-btn--emphasized" [routerLink]="getReviewRoute()">
            Revisar y publicar encuesta
          </a>
        </div>
      }
    }
  </div>
</app-wizard-layout>
